"""
Shinden3 Ã— ChatGPT å°†æ£‹è§£èª¬AI
---------------------------------
æŒ¯é›»ï¼“ã‚¨ãƒ³ã‚¸ãƒ³ã§å°†æ£‹å±€é¢ã‚’è§£æã—ã€
ChatGPTï¼ˆGPT-5ï¼‰ãŒã‚ã‹ã‚Šã‚„ã™ãäººé–“å‘ã‘ã«è§£èª¬ã—ã¾ã™ã€‚
"""

import os
import subprocess
from dotenv import load_dotenv
from openai import OpenAI

# ==============================
# åˆæœŸè¨­å®š
# ==============================
load_dotenv()
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
ENGINE_PATH = os.getenv("ENGINE_PATH")

if not OPENAI_API_KEY:
    raise ValueError("âŒ OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'.env' ã« OPENAI_API_KEY ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚")
if not ENGINE_PATH or not os.path.exists(ENGINE_PATH):
    raise ValueError("âŒ æŒ¯é›»ï¼“ã‚¨ãƒ³ã‚¸ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'.env' ã« ENGINE_PATH ã‚’æ­£ã—ãè¨­å®šã—ã¦ãã ã•ã„ã€‚")

# ==============================
# æŒ¯é›»ï¼“ ã‚¨ãƒ³ã‚¸ãƒ³æ“ä½œã‚¯ãƒ©ã‚¹
# ==============================
class Shinden3Engine:
    def __init__(self, engine_path):
        self.engine = subprocess.Popen(
            [engine_path],
            stdin=subprocess.PIPE,
            stdout=subprocess.PIPE,
            text=True,
            bufsize=1
        )
        self._send("usi")
        self._wait_ready()

    def _send(self, cmd):
        self.engine.stdin.write(cmd + "\n")
        self.engine.stdin.flush()

    def _wait_ready(self):
        while True:
            line = self.engine.stdout.readline().strip()
            if line == "usiok":
                break

    def analyze(self, position="startpos", depth=10):
        """å±€é¢ã‚’è§£æã—ã¦USIå‡ºåŠ›ã‚’è¿”ã™"""
        self._send(f"position {position}")
        self._send(f"go depth {depth}")
        lines = []
        while True:
            line = self.engine.stdout.readline().strip()
            lines.append(line)
            if line.startswith("bestmove"):
                break
        return "\n".join(lines)

    def quit(self):
        self._send("quit")

# ==============================
# ChatGPT è§£èª¬ã‚¯ãƒ©ã‚¹
# ==============================
class GPTCommentator:
    def __init__(self, api_key):
        self.client = OpenAI(api_key=api_key)

    def explain(self, analysis_text):
        """AIå‡ºåŠ›ã‚’äººé–“å‘ã‘ã«è‡ªç„¶æ–‡ã§è§£èª¬"""
        prompt = f"""
ä»¥ä¸‹ã¯å°†æ£‹AIã€ŒæŒ¯é›»ï¼“ã€ã®è§£æå‡ºåŠ›ã§ã™ã€‚
ã“ã‚Œã‚’äººé–“ã«ã‚ã‹ã‚Šã‚„ã™ãã€å½¢å‹¢ã‚„ç‹™ã„ç­‹ã€æˆ¦æ³•ã®æ„å›³ã‚’å«ã‚ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

è§£æå‡ºåŠ›:
{analysis_text}
"""

        response = self.client.chat.completions.create(
            model="gpt-5",
            messages=[
                {"role": "system", "content": "ã‚ãªãŸã¯å°†æ£‹ã®ãƒ—ãƒ­è§£èª¬è€…ã§ã™ã€‚åˆå¿ƒè€…ã«ã‚‚åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚"},
                {"role": "user", "content": prompt}
            ]
        )
        return response.choices[0].message.content.strip()

# ==============================
# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
# ==============================
def main():
    print("ğŸ”¹ æŒ¯é›»ï¼“ã‚¨ãƒ³ã‚¸ãƒ³ã‚’èµ·å‹•ä¸­...")
    engine = Shinden3Engine(ENGINE_PATH)
    gpt = GPTCommentator(OPENAI_API_KEY)

    print("ğŸ”¹ å±€é¢ã‚’è§£æä¸­...")
    result = engine.analyze("startpos", depth=8)
    print("âœ… è§£æå®Œäº†ã€‚\n")

    print("ğŸ”¹ ChatGPTãŒè§£èª¬ã‚’ä½œæˆä¸­...\n")
    comment = gpt.explain(result)

    print("ğŸ¯ === è§£èª¬ ===")
    print(comment)

    engine.quit()
    print("\nğŸ çµ‚äº†ã—ã¾ã—ãŸã€‚")

# ==============================
# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
# ==============================
if __name__ == "__main__":
    main()
